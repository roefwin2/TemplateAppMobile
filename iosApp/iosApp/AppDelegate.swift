//
//  AppDelegate.swift
//  iosApp
//
//  Generated by KMPNotifier Plugin
//

import SwiftUI
import FirebaseCore
import FirebaseMessaging
import UserNotifications
import ComposeApp

class AppDelegate: NSObject, UIApplicationDelegate, UNUserNotificationCenterDelegate, MessagingDelegate {

    func application(_ application: UIApplication,
                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]? = nil) -> Bool {

        // DÃ©lÃ©guÃ© des notifications systÃ¨me pour intercepter foreground/click
        UNUserNotificationCenter.current().delegate = self

        // DÃ©lÃ©guÃ© Firebase Messaging (token FCM, refreshâ€¦)
        Messaging.messaging().delegate = self

        // S'inscrire aux remote notifications (APNs)
        DispatchQueue.main.async {
            UIApplication.shared.registerForRemoteNotifications()
        }
        return true
    }

    // ReÃ§oit le device token APNs -> le passe Ã  FCM
    func application(_ application: UIApplication,
                     didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        Messaging.messaging().apnsToken = deviceToken
    }

    // Si l'enregistrement APNs Ã©choue
    func application(_ application: UIApplication,
                     didFailToRegisterForRemoteNotificationsWithError error: Error) {
        print("âŒ APNs registration failed: \(error)")
    }

    // Affichage d'une notif en foreground (iOS 10+)
    func userNotificationCenter(_ center: UNUserNotificationCenter,
                                willPresent notification: UNNotification,
                                withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
        // Laisse KMPNotifier traiter le payload data
        let userInfo = notification.request.content.userInfo
        NotifierManager.shared.onApplicationDidReceiveRemoteNotification(userInfo: userInfo)

        // Afficher en foreground (alerte/son/badge)
        completionHandler([.banner, .sound, .badge])
    }

    // Click sur la notification (tap)
    func userNotificationCenter(_ center: UNUserNotificationCenter,
                                didReceive response: UNNotificationResponse,
                                withCompletionHandler completionHandler: @escaping () -> Void) {
        let userInfo = response.notification.request.content.userInfo

        // Informe KMPNotifier (dÃ©clenchera onNotificationClicked cÃ´tÃ© shared)
        NotifierManager.shared.onApplicationDidReceiveRemoteNotification(userInfo: userInfo)

        completionHandler()
    }

    // Token FCM (utile pour l'envoyer Ã  ton backend)
    func messaging(_ messaging: Messaging, didReceiveRegistrationToken fcmToken: String?) {
        if let token = fcmToken {
            print("ðŸ”‘ FCM token (iOS): \(token)")
        }
    }
}